"use strict";(this.webpackChunkexcalidraw_app=this.webpackChunkexcalidraw_app||[]).push([[894],{48927:function(t,n,e){e.r(n),e.d(n,{default:function(){return M}});var r=e(1413),o=e(4519),i=e(45204),a="index_undoRedo__mOw1J",c="index_canvas__s497j",l="index_container__JGkWk",u="index_btnRow__ReEOR",s=e(93433),f=function(t,n,e){var r=t.getContext("2d");r.clearRect(0,0,t.width,t.height),function(t,n,e){e.forEach((function(n){t.save(),t.beginPath(),t.lineWidth=3,t.strokeStyle=n.strokeStyle,n.points.forEach((function(e,r){r?t.lineTo.apply(t,(0,s.Z)(e)):t.moveTo.apply(t,(0,s.Z)(n.points[0]))})),t.stroke(),t.restore()}))}(r,0,e)},h=e(15671),d=e(43144),v=function t(n){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(null==n||"object"!==typeof n)return n;if("[object Object]"===Object.prototype.toString.call(n)){var r="function"===typeof n.constructor?Object.create(Object.getPrototypeOf(n)):{};for(var o in n)if(n.hasOwnProperty(o)){if(0===e&&("shape"===o||"canvas"===o))continue;r[o]=t(n[o],e+1)}return r}if(Array.isArray(n)){for(var i=n.length,a=new Array(i);i--;)a[i]=t(n[i],e+1);return a}return n},p=function(){function t(){var n=this;(0,h.Z)(this,t),this.generateEntry=function(t,e){return n.dehydrateHistoryEntry({appState:t,elements:e})},this.elementCache={},this.stateHistory=[],this.redoStack=[],this.lastEntry=null}return(0,d.Z)(t,[{key:"hydrateHistoryEntry",value:function(t){var n=this,e=t.appState,r=t.elements;return{appState:JSON.parse(e),elements:r.map((function(t){var e=n.elementCache[t];if(!e)throw new Error("Element not found: ".concat(t));return e}))}}},{key:"dehydrateHistoryEntry",value:function(t){var n=this,e=t.appState,r=t.elements;return{appState:JSON.stringify(e),elements:r.map((function(t){var e=t.id,r=t.versionNonce;return n.elementCache["".concat(e,"-").concat(r)]=v(t),"".concat(t.id,"-").concat(t.versionNonce)}))}}},{key:"pushEntry",value:function(t,n){var e=this.generateEntry(t,n);this.stateHistory.push(e),this.clearRedoStack()}},{key:"clearRedoStack",value:function(){this.redoStack.splice(0,this.redoStack.length)}},{key:"redoOnce",value:function(){if(0===this.redoStack.length)return null;var t=this.redoStack.pop();return void 0!==t?(this.stateHistory.push(t),this.hydrateHistoryEntry(t)):null}},{key:"undoOnce",value:function(){if(1===this.stateHistory.length)return null;var t=this.stateHistory.pop(),n=this.stateHistory[this.stateHistory.length-1];return void 0!==t?(this.redoStack.push(t),this.hydrateHistoryEntry(n)):null}},{key:"record",value:function(t,n){console.log("\u5f00\u59cb\u8bb0\u5f55\u3002\u3002\u3002\u3002"),this.pushEntry(t,n),console.log("\u8bb0\u5f55\u5b8c\u6210...",this)}},{key:"clear",value:function(){this.stateHistory.length=0,this.redoStack.length=0,this.lastEntry=null,this.elementCache.clear()}}]),t}(),y=p,m=e(2556),g=JSON.parse(localStorage.getItem("free-draw-elements"))||[],w={offsetLeft:0,offsetTop:0,scrollX:0,scrollY:0,draggingElement:null},x=new y;window.__history=x,console.log("history...",x);var M=(0,o.memo)((function(){var t=(0,o.useRef)(null),n=(0,o.useRef)(null);(0,o.useEffect)((function(){var e=t.current,r=e.getContext("2d"),o=e.offsetWidth,i=e.offsetHeight,a=e.offsetLeft,c=e.offsetTop;e.width=o*window.devicePixelRatio,e.height=i*window.devicePixelRatio,r.scale(window.devicePixelRatio,window.devicePixelRatio),w.offsetLeft=a,w.offsetTop=c,f(e,w,g),x.record(w,g);var l=n.current,u=function(t){t.preventDefault()};return l.addEventListener("wheel",u,{passive:!1}),function(){l.removeEventListener("wheel",u)}}),[]);var e=function(n){return function(n){var e=(0,i.dE)(n,w);w.draggingElement.points.push([e.x,e.y]),w.draggingElement.versionNonce=Math.floor(Math.random()*Math.pow(2,31)),f(t.current,w,g)}},s=function(t){return function(){x.record(w,g),window.removeEventListener("pointermove",t.eventListeners.onMove),window.removeEventListener("pointerup",t.eventListeners.onUp)}};return(0,m.jsx)("div",{className:a,children:(0,m.jsxs)("div",{className:l,ref:n,children:[(0,m.jsx)("canvas",{ref:t,className:c,onPointerDown:function(t){var n=(0,i.dE)(t,w),o={origin:n,lastCoords:(0,r.Z)({},n),eventListeners:{onMove:null,onUp:null}},a={x:o.origin.x,id:Math.floor(Math.random()*Math.pow(2,31)),y:o.origin.y,points:[[o.origin.x,o.origin.y]],strokeColor:"#000000",backgroundColor:"transparent",fillStyle:"hachure",strokeWidth:1,strokeStyle:(0,i.B8)(),versionNonce:Math.floor(Math.random()*Math.pow(2,31))};w.draggingElement=a,g.push(a);var c=e(o),l=s(o);window.addEventListener("pointermove",c),window.addEventListener("pointerup",l),o.eventListeners.onMove=c,o.eventListeners.onUp=l},children:"\u7ed8\u5236canvas"}),(0,m.jsxs)("div",{className:u,children:[(0,m.jsx)("button",{onClick:function(){var n=x.undoOnce();console.log("\u64a4\u9500\u3002\u3002\u3002",n),n&&(g=n.elements,f(t.current,w,g))},children:"\u64a4\u9500"}),(0,m.jsx)("button",{onClick:function(){var n=x.redoOnce();console.log("\u91cd\u505a...",n),n&&(g=n.elements,f(t.current,w,g))},children:"\u91cd\u505a"})]})]})})}))},45204:function(t,n,e){e.d(n,{$9:function(){return u},B8:function(){return l},KP:function(){return d},Pi:function(){return h},TE:function(){return p},dE:function(){return c},kb:function(){return m},mO:function(){return g},qf:function(){return v}});var r=e(29439),o=e(37762),i=e(93433),a=e(84453),c=function(t,n){var e=t.clientX,r=t.clientY,o=n.zoom,i=n.offsetLeft,a=n.offsetTop,c=n.scrollX,l=n.scrollY,u=o?o.value:1;return{x:(e-i)/u-c,y:(r-a)/u-l}},l=function(){var t=Math.floor(256*Math.random()),n=Math.floor(256*Math.random()),e=Math.floor(256*Math.random());return"rgb(".concat(t,",").concat(n,",").concat(e,")")},u=function(t){return function(t,n){var e=null,r=null,o=null,a=function n(a){e=window.requestAnimationFrame((function(){e=null,t.apply(void 0,(0,i.Z)(a)),r=null,o&&(r=o,o=null,n(r))}))},c=function(){for(var t=arguments.length,i=new Array(t),c=0;c<t;c++)i[c]=arguments[c];r=i,null===e?a(r):null!==n&&void 0!==n&&n.trailing&&(o=i)};return c.flush=function(){null!==e&&(cancelAnimationFrame(e),e=null),r&&(t.apply(void 0,(0,i.Z)(o||r)),r=o=null)},c.cancel=function(){r=o=null,null!==e&&(cancelAnimationFrame(e),e=null)},c}((function(n){(0,a.unstable_batchedUpdates)(t,n)}))},s=function(t){var n=1/0,e=1/0,i=-1/0,a=-1/0,c=t.points;"freedraw"===t.type&&(c=t.points.map((function(n){return[n[0]-t.x,n[1]-t.y]})));var l,u=(0,o.Z)(c);try{for(u.s();!(l=u.n()).done;){var s=(0,r.Z)(l.value,2),f=s[0],h=s[1];n=Math.min(n,f),e=Math.min(e,h),i=Math.max(i,f),a=Math.max(a,h)}}catch(d){u.e(d)}finally{u.f()}return[n,e,i,a]},f=function(t,n,e,r,o){return[(t-e)*Math.cos(o)-(n-r)*Math.sin(o)+e,(t-e)*Math.sin(o)+(n-r)*Math.cos(o)+r]},h=function(t){var n=v(t),e=(0,r.Z)(n,6),o=e[0],i=e[1],a=e[2],c=e[3],l=e[4],u=e[5];if("freedraw"===t.type){var h=s(t),d=(0,r.Z)(h,4),p=d[0],y=d[1],m=d[2],g=d[3];return[p+t.x,y+t.y,m+t.x,g+t.y]}var w=f(o,i,l,u,t.angle),x=(0,r.Z)(w,2),M=x[0],k=x[1],E=f(o,c,l,u,t.angle),S=(0,r.Z)(E,2),b=S[0],Z=S[1],_=f(a,c,l,u,t.angle),O=(0,r.Z)(_,2),L=O[0],j=O[1],H=f(a,i,l,u,t.angle),C=(0,r.Z)(H,2),R=C[0],N=C[1];return[Math.min(M,b,L,R),Math.min(k,Z,j,N),Math.max(M,b,L,R),Math.max(k,Z,j,N)]},d=function(t){if(!t.length)return[0,0,0,0];var n=1/0,e=-1/0,o=1/0,i=-1/0;return t.forEach((function(t){var a=h(t),c=(0,r.Z)(a,4),l=c[0],u=c[1],s=c[2],f=c[3];n=Math.min(n,l),o=Math.min(o,u),e=Math.max(e,s),i=Math.max(i,f)})),[n,o,e,i]},v=function(t){if("freedraw"===t.type){var n=s(t),e=(0,r.Z)(n,4),o=e[0],i=e[1],a=e[2],c=e[3],l=o+t.x,u=i+t.y,f=a+t.x,h=c+t.y;return[l,u,f,h,(l+f)/2,(u+h)/2]}return[t.x,t.y,t.x+t.width,t.y+t.height,t.x+t.width/2,t.y+t.height/2]},p=function(t,n){return Math.abs(t-n)},y=0,m=function(){return"id".concat(y++)},g=function(t){var n=t.fontSize,e=t.fontFamily;return"".concat(n,"px ").concat(e,", Segoe UI Emoji")}}}]);
//# sourceMappingURL=UndoRedo.6c2e517b.chunk.js.map