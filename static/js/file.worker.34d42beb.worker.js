!function(){"use strict";function e(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function t(t,n){if(t){if("string"===typeof t)return e(t,n);var r=Object.prototype.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?e(t,n):void 0}}function n(e,n){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,a,o,l,i=[],c=!0,s=!1;try{if(o=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;c=!1}else for(;!(c=(r=o.call(n)).done)&&(i.push(r.value),i.length!==t);c=!0);}catch(f){s=!0,a=f}finally{try{if(!c&&null!=n.return&&(l=n.return(),Object(l)!==l))return}finally{if(s)throw a}}return i}}(e,n)||t(e,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}var r=function(e){var r=1/0,a=1/0,o=-1/0,l=-1/0,i=e.points;"freedraw"===e.type&&(i=e.points.map((function(t){return[t[0]-e.x,t[1]-e.y]})));var c,s=function(e,n){var r="undefined"!==typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=t(e))||n&&e&&"number"===typeof e.length){r&&(e=r);var a=0,o=function(){};return{s:o,n:function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var l,i=!0,c=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){c=!0,l=e},f:function(){try{i||null==r.return||r.return()}finally{if(c)throw l}}}}(i);try{for(s.s();!(c=s.n()).done;){var f=n(c.value,2),u=f[0],v=f[1];r=Math.min(r,u),a=Math.min(a,v),o=Math.max(o,u),l=Math.max(l,v)}}catch(h){s.e(h)}finally{s.f()}return[r,a,o,l]},a=function(e,t){return Math.abs(e-t)},o=function(e){if("freedraw"===e.type){var t=n(r(e),4),a=t[0],o=t[1],l=t[2],i=t[3],c=a+e.x,s=o+e.y,f=l+e.x,u=i+e.y;return[c,s,f,u,(c+f)/2,(s+u)/2]}return[e.x,e.y,e.x+e.width,e.y+e.height,e.x+e.width/2,e.y+e.height/2]},l=function(e,t,n,r,a){return[(e-n)*Math.cos(a)-(t-r)*Math.sin(a)+n,(e-n)*Math.sin(a)+(t-r)*Math.cos(a)+r]},i=function(e,t){var n=e.clientX,r=e.clientY,a=t.zoom,o=t.offsetLeft,l=t.offsetTop,i=t.scrollX,c=t.scrollY,s=a?a.value:1;return{x:(n-o)/s-i,y:(r-l)/s-c}},c={},s=function(e,t){var n=c[e.id];if(n&&!t.notUseCache)return console.log("worker\u590d\u7528cache==========================="),n;var r=u(e,t.zoom,t);return t.notUseCache||(c[e.id]=r),r},f="object"===typeof document,u=function(e,t,r){var l,i,c=f?window.devicePixelRatio:r.devicePixelRatio,s=h(e);if("freedraw"===e.type){var u,y,d=n(o(e),4),m=d[0],p=d[1],g=d[2],x=d[3];i=(l=new OffscreenCanvas(a(m,g)*c*t.value+s*t.value*2,a(p,x)*c*t.value+s*t.value*2)).getContext("2d"),u=e.x>m?a(e.x,m)*c*t.value:0,y=e.y>p?a(e.y,p)*t.value*c:0,i.translate(u,y)}else i=(l=new OffscreenCanvas(e.width*c*t.value+s*t.value*2,e.height*c*t.value+s*t.value*2)).getContext("2d");return i.save(),i.translate(s*t.value,s*t.value),i.scale(c*t.value,c*t.value),v(e,i,r),i.restore(),{element:e,canvas:l,theme:r.theme,canvasZoom:t,canvasOffsetX:0,canvasOffsetY:0}},v=function(e,t,r){switch(t.globalAlpha=e.opacity/100,e.type){case"rectangle":t.lineJoin="round",t.lineCap="round",t.lineWidth=e.strokeWidth,t.strokeStyle=r.strokeStyle||e.strokeStyle,t.strokeRect(0,0,e.width,e.height);break;case"text":t.font=function(e){var t=e.fontSize,n=e.fontFamily;return"".concat(t,"px ").concat(n,", Segoe UI Emoji")}(e),t.fillStyle=r.fillStyle||e.strokeColor,t.textAlign=e.textAlign;var a=e.text.split("\n"),o=a.length?e.height/a.length:18;t.textBaseline="bottom";for(var l=0;l<a.length;l++)t.fillText(a[l],0,(l+1)*o);break;case"freedraw":t.save(),t.lineWidth=e.strokeWidth,t.strokeStyle=r.strokeStyle||e.strokeStyle,e.points.forEach((function(r,a){var o=n(r,2),l=o[0],i=o[1];l-=e.x,i-=e.y,a?t.lineTo(l,i):t.moveTo(l,i)})),t.stroke(),t.restore()}t.globalAlpha=1},h=function(e){return"freedraw"===e.type?12*e.strokeWidth:20},y=function(e,t,r){var a=f?window.devicePixelRatio:r.devicePixelRatio,l=e.element,i=h(l),c=n(o(l),4),s=c[0],u=c[1],v=c[2],y=c[3];if("freedraw"===l.type){var d=n(o(l),4);s=d[0],u=d[1],v=d[2],y=d[3]}var m=((s+v)/2+r.scrollX)*a,p=((u+y)/2+r.scrollY)*a;t.save(),t.scale(1/a,1/a),t.translate(m,p),t.drawImage(e.canvas,-(v-s)/2*a-i*e.canvasZoom.value/e.canvasZoom.value,-(y-u)/2*a-i*e.canvasZoom.value/e.canvasZoom.value,e.canvas.width/e.canvasZoom.value,e.canvas.height/e.canvasZoom.value),t.restore()},d=function(e,t,a,c){var s=function(e){var t=n(o(e),6),a=t[0],i=t[1],c=t[2],s=t[3],f=t[4],u=t[5];if("freedraw"===e.type){var v=n(r(e),4),h=v[0],y=v[1],d=v[2],m=v[3];return[h+e.x,y+e.y,d+e.x,m+e.y]}var p=n(l(a,i,f,u,e.angle),2),g=p[0],x=p[1],w=n(l(a,s,f,u,e.angle),2),b=w[0],S=w[1],k=n(l(c,s,f,u,e.angle),2),M=k[0],C=k[1],A=n(l(c,i,f,u,e.angle),2),T=A[0],I=A[1];return[Math.min(g,b,M,T),Math.min(x,S,C,I),Math.max(g,b,M,T),Math.max(x,S,C,I)]}(e),f=n(s,4),u=f[0],v=f[1],h=f[2],y=f[3],d=i({clientX:c.offsetLeft,clientY:c.offsetTop},c),m=i({clientX:c.offsetLeft+t,clientY:c.offsetTop+a},c);return d.x<=h&&d.y<=y&&m.x>=u&&m.y>=v},m=function(e){var t=e.elements,n=e.appState,r=e.scale,a=e.canvas,o=e.renderConfig,l=a.getContext("2d");l.save(),l.scale(r,r);var i=a.width/r,f=a.height/r;if(l.clearRect(0,0,i,f),l.save(),l.scale(o.zoom.value,o.zoom.value),o.isExport,t){var u=t.filter((function(e){var t=d(e,i,f,{zoom:o.zoom,offsetLeft:n.offsetLeft,offsetTop:n.offsetTop,scrollX:o.scrollX,scrollY:o.scrollY}),r=c[e.id];return t&&r&&o.zoom.value!==r.canvasZoom.value&&function(e){delete c[e.id]}(e),t}));console.log("worker\u7ed8\u5236\u5143\u7d20\u603b\u6570\uff1a".concat(t.length,"\uff0c\u5b9e\u9645\u7ed8\u5236\u5143\u7d20\u603b\u6570\uff1a").concat(u.length)),u.forEach((function(e){!function(e,t,n,r){var a=s(e,n);y(a,t,n)}(e,l,o)}))}l.restore(),l.restore()};let p=null,g=null;self.onmessage=e=>{const{elements:t,canvasWorker:n,canvasImgWorker:r,appState:a,scale:o,renderConfig:l,type:i}=e.data;"init"!==i&&"redraw"!==i||(n&&(p=n),m({elements:t,appState:a,scale:o,canvas:p,renderConfig:l})),"init-img"!==i&&"redraw-img"!==i||(r&&(g=r),m({elements:t,appState:a,scale:o,canvasImg:g,renderConfig:l}),postMessage({type:"img-finish"}))}}();
//# sourceMappingURL=file.worker.34d42beb.worker.js.map