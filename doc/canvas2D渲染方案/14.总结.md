不知不觉已经写了差不多 16 篇关于 canvas 及其性能优化的文档。从一开始模仿 excalidraw 到超越 excalidraw，再到实践更多的优化手段并输出 demo，历时半个月。本系列文档分为三个部分：

1.性能分析。掌握 canvas 性能分析工具是很重要的，所有的优化手段都需要基于这些工具的数据结果，才能客观公正衡量我们所使用的优化手段带来的提升结果。

2.内存开销。了解每个 canvas 所需要的 GPU 内存开销，可以帮助我们合理决策，比如在使用离屏 canvas 优化时，虽然速度带来了提升，但 GPU 内存开销相应的也增加了。需要在速度和内存之间做个合理决策

3.渐进式的优化手段。本系列后面几章渐进式的介绍了各种优化手段的基本原理、带来的性能提升以及不足。

本系列文章递进式地介绍了各种性能优化手段，让我们能够充分认识到都有哪些可以优化的手段提升画布的性能，并介绍了每种方案的优点和缺点。理论上，在元素量巨大的情况下，即使是再优秀的方案最终都会遇到瓶颈。没有绝对完美的解决方案，只有贴合业务的更优的解决方案。我们能够做的就是根据不同的业务场景选择合适、简洁的手段实现我们的需求。比如，如果我们的业务场景从设计之初只考虑最多 5000 个元素的情况下，我们就可以选择只绘制可视区域内元素的手段做优化即可。如果我们的业务场景没有无限画布及缩放的需求，那么就只需要使用分层画布提高书写速度即可。

实际上，在 canvas 画布中，编辑、绘制元素的性能很容易解决。但是对于无限画布来说，平移缩放是最大的瓶颈，也是重点需要关注的场景。当然对于一些低端设备，比如大板上的安卓操作系统，我们能够做的除了将 web 性能做到最好以外，估计真的还需要借助原生的能力做加速。目前这部分还没实践

## 影响 canvas 性能的因素

1.尽量减少文本的绘制。绘制文本的开销是比较大的

2.尽量减少阴影 shadowBlur 的使用。

3.尽可能少的改变 canvas 的状态。canvas 底层是使用状态机实现的，频繁的修改 canvas 的状态，比如颜色、线宽等，开销是昂贵的

等等。。。

## 性能优化其余手段

1.动态分层。根据元素数量自动分层，比如每 500 个元素一层 canvas。这种方案实践了下发现效果不是很理想

2.脏区检测。社区上也有很多这种方案，局部绘制的一种方案。操作起来比较麻烦

3.webgl 硬件加速。

等等。。。

## 参考资料

在做任何方向的技术调研时，我们需要尽可能多的阅读相关的文档，收集更多的资料。这些资料是支撑我们实践的理论基础，能够少走弯路。下面是我在调研之初阅读的一些我觉得比较好的文档资料，供大家参考

- [canvas 基础](http://diveintohtml5.info/canvas.html)

- [https://web.dev/canvas-performance/](https://web.dev/canvas-performance/)。canvas 性能圣经

- [OffscreenCanvas — Speed up Your Canvas Operations with a Web Worker](https://developer.chrome.com/blog/offscreen-canvas/)

- [Offscreen Canvas Example](https://github.com/mdn/dom-examples/tree/main/web-workers/offscreen-canvas-worker)

- [Offscreen Canvas Online Demo](https://mdn.github.io/dom-examples/web-workers/offscreen-canvas-worker/)

- [Optimizing your JavaScript game for Firefox OS](https://hacks.mozilla.org/2013/05/optimizing-your-javascript-game-for-firefox-os/)

- [MDN: Optimizing canvas](https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API/Tutorial/Optimizing_canvas)

- [https://github.com/excalidraw/excalidraw/issues/5192](https://github.com/excalidraw/excalidraw/issues/5192)

- [OffscreenCanvas 与 requestAnimationFrame](https://wiki.whatwg.org/wiki/OffscreenCanvas.requestAnimationFrame)
